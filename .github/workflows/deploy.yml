# å·¥ä½œæµåç§°ï¼šéƒ¨ç½² Node.js åº”ç”¨åˆ° GitHub Pages
name: Deploy zhaomoshou to GitHub Pages

# è§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: ['main'] # å¦‚æœä½ çš„é»˜è®¤åˆ†æ”¯æ˜¯ masterï¼Œè¯·æ”¹ä¸º ['master']

  # å…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºè°ƒè¯•æˆ–å¼ºåˆ¶é‡æ–°éƒ¨ç½²ï¼‰
  workflow_dispatch:

# å…¨å±€æƒé™è®¾ç½®ï¼ˆå¿…é¡»ï¼ç”¨äºå®‰å…¨åœ°éƒ¨ç½²åˆ° GitHub Pagesï¼‰
permissions:
  contents: write # å…è®¸è¯»å–ä»“åº“ä»£ç 
  pages: write # å…è®¸å†™å…¥ GitHub Pages
  id-token: write # å…è®¸ä½¿ç”¨ OIDC è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆå®‰å…¨ä»¤ç‰Œï¼‰

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡ï¼ˆJobsï¼‰
jobs:
  # =============
  # ä»»åŠ¡ 1: æ„å»ºé™æ€æ–‡ä»¶
  # =============
  build:
    name: Build static site
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è™šæ‹Ÿç¯å¢ƒ
    env:
      TZ: 'Asia/Shanghai'  # ğŸ‘ˆ å…³é”®ï¼è®¾ç½®ä¸ºä¸­å›½æ—¶åŒº
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22' # ä½¿ç”¨ä½ é¡¹ç›®æ‰€éœ€çš„ Node.js ç‰ˆæœ¬
          cache: 'npm' # è‡ªåŠ¨ç¼“å­˜ node_modulesï¼ŒåŠ é€Ÿåç»­æ„å»º

      # 3. å®‰è£…ä¾èµ–ï¼ˆæ”¯æŒ npm / yarn / pnpmï¼‰
      - name: Install dependencies
        run: npm ci # æ¨èä½¿ç”¨ `npm ci`ï¼ˆæ¯” `npm install` æ›´å¿«ã€æ›´å¯é ï¼‰

        # ===== æ–°å¢ï¼šä¸‹è½½ä¹‹å‰çš„æ„å»ºæ–‡ä»¶ =====
      - name: Download previous build files
        uses: actions/download-artifact@v4
        with:
          name: previous-build
          path: ./previous-dist
        continue-on-error: true  # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ„å»ºï¼Œæ²¡æœ‰ä¹‹å‰çš„æ–‡ä»¶å°±è·³è¿‡
      
      # ===== æ–°å¢ï¼šæ¢å¤ä¹‹å‰çš„æ–‡ä»¶åˆ°æ„å»ºç›®å½• =====
      - name: Restore previous files
        run: |
          mkdir -p ./dist
          if [ -d "./previous-dist" ] && [ "$(ls -A ./previous-dist)" ]; then
            cp -r ./previous-dist/* ./dist/
            echo "Restored previous build files"
          else
            echo "No previous build files found, starting fresh"
          fi

      # 4. æ„å»ºé™æ€æ–‡ä»¶
      #    å‡è®¾ä½ çš„ package.json ä¸­æœ‰ "scripts": { "build": "node build.js" }
      - name: Build static site
        run: npm run build # ç¡®ä¿æ­¤å‘½ä»¤ä¼šç”Ÿæˆ ./dist ç›®å½•ï¼ˆæˆ–ä½ æŒ‡å®šçš„è¾“å‡ºç›®å½•ï¼‰

      # ===== æ–°å¢ï¼šä¿å­˜å½“å‰æ„å»ºä½œä¸ºä¸‹æ¬¡çš„"ä¹‹å‰ç‰ˆæœ¬" =====
      - name: Upload current build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: previous-build
          path: ./dist
          retention-days: 1  # åªä¿ç•™1å¤©ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦ä¸Šä¸€æ¬¡çš„

      # 5. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¾›éƒ¨ç½²ä»»åŠ¡ä½¿ç”¨ï¼‰
      #    æ³¨æ„ï¼šè·¯å¾„å¿…é¡»ä¸ä½ çš„æ„å»ºè¾“å‡ºç›®å½•ä¸€è‡´ï¼ˆå¦‚ dist, public, build ç­‰ï¼‰
      - name: Upload build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist # âœ… ç¡®ä¿è¿™ä¸ªè·¯å¾„å­˜åœ¨ä¸”åŒ…å« index.htmlï¼
      
      - name: Auto commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update build artifacts [skip ci]"
          file_pattern: "data/**"
          skip_dirty_check: true

  # =============
  # ä»»åŠ¡ 2: éƒ¨ç½²åˆ° GitHub Pages
  # =============
  deploy:
    name: Deploy to GitHub Pages
    # ä¾èµ– build ä»»åŠ¡ï¼Œåªæœ‰ build æˆåŠŸæ‰ä¼šæ‰§è¡Œ deploy
    needs: build

    # æŒ‡å®šè¿è¡Œç¯å¢ƒï¼ˆå¿…é¡»ä¸ GitHub Pages é›†æˆï¼‰
    environment:
      name: github-pages # ç¯å¢ƒåç§°ï¼ˆä¼šåœ¨ä»“åº“ Settings > Environments ä¸­æ˜¾ç¤ºï¼‰
      url: ${{ steps.deployment.outputs.page_url }} # éƒ¨ç½²æˆåŠŸåæ˜¾ç¤ºå¯ç‚¹å‡»çš„ç½‘ç«™é“¾æ¥

    runs-on: ubuntu-latest

    # éƒ¨ç½²æ­¥éª¤ï¼ˆå¿…é¡»ç‹¬ç«‹ï¼Œä¸èƒ½ä¸æ„å»ºæ··åœ¨ä¸€èµ·ï¼‰
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # GitHub å®˜æ–¹éƒ¨ç½² Actionï¼ˆæ— éœ€åˆ†æ”¯ï¼Œæ›´å®‰å…¨ï¼‰
